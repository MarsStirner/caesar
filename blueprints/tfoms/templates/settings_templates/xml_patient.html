{% extends 'base.html' %}

{% block modules_css %}
<link href="{{ url_for('.static', filename='css/style.css') }}" rel="stylesheet">
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/humanity/jquery-ui.css" />
  <style>
	  .tags ul { list-style-type: none; margin: 0px; padding: 0; margin-bottom: 0px; }
	  .tags li { margin: 0px; padding: 0;}
	  .ui-state-highlight { background-color: #CCCCCC; height: 1.5em; line-height: 1.2em; border: dashed 1px gray; }
	  .sortable ul {margin:0px 0px 0px 25px; padding: 8px 0px 0px 0px;}
      .children {border-left:1px dotted; }
      #root {padding: 8px 0px 0px 0px;}


  </style>
{% endblock %}

{% block content %}

    {% include '_nav_menu.html' %}
        <legend>Настройка шаблонов реестров для выгрузки в ТФОМС</legend>
        {% include 'settings_templates/_sub_menu.html' %}

        <div class="row-fluid">
            <div class="span4">
                  <ul class="nav nav-list nav-stacked">
                       <li class="">Созданные шаблоны <span class="pull-right">Участвует в выгрузке</span></li>
                       <li class="divider"></li>
                       {% for template in templates %}
                            {% set id = template.id %}
                            {% if id == current_id %}
                                <li class="active">
                                    <span class="pull-right">
                                        {% if template.is_active %}
                                            <input class="is_active" type="radio" name="is_active" value="{{ id }}" checked/>
                                        {% else %}
                                            <input class="is_active" type="radio" name="is_active" value="{{ id }}" />
                                        {% endif %}
                                    </span>
                                    <a href={{ url_for('.settings_template', template_type='xml_patient', id=id) }}>{{template.name}}</a>
                                </li>
                            {% else %}
                                <li>
                                    <span class="pull-right">
                                        {% if template.is_active %}
                                            <input class="is_active" type="radio" name="is_active" value="{{ id }}" checked/>
                                        {% else %}
                                            <input class="is_active" type="radio" name="is_active" value="{{ id }}"  />
                                        {% endif %}
                                    </span>
                                    <a href={{ url_for('.settings_template', template_type='xml_patient', id=id) }}>{{template.name}}</a>
                                </li>
                            {% endif %}
                       {% endfor%}
                       <li class="divider"></li>
                       <li>
                            <span class="pull-left">
                                <a href={{ url_for('.add_new_template', template_type='xml_patient', action='add_new') }}>
                                    <i class=" icon-plus-sign"></i>Добавить новый
                                </a>
                            </span>
                       </li>
                </ul>
            </div>
            <div class="span8">
                <form class="form-horizontal" method=post>
                    <legend>Параметры шаблона:</legend>

                    <div class="control-group">
                        <label class="control-label">Название шаблона:</label>
                        <div class="controls">
                            {{ form.name(class='span') }}
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Архивировать файл:</label>
                        <div class="controls">
                            {{ form.archive }}
                        </div>
                    </div>

                    <legend style="font-size:14px;">Состав и порядок размещения данных в шаблоне:</legend>
                    <div class="row-fluid col-wrap tags">
                        <div class="span7 well col" id="used">
                           <legend >Попадают в реестр</legend>
                           <ul id="root" class="sortable">
                           {%- for tag in tag_tree -%}
                                {%- if loop.index0 == 0 -%}
                                  <li>
                                        {{tag.value.tag.code}}  ({{tag.value.tag.name}})
                                        <input type="hidden" name="tag[{{tag.value.id}},{{ tag.value.tag.id }}]" value="{{tag.value.parent_id}},{{tag.value.ordernum}}">
                                        <ul id="sortable" class=" sortable">
                                {%- else -%}
                                    {% set k = tag_tree[loop.index0 - 1].level-tag.level %}
                                    {%- if k == 0 -%}
                                        </ul>
                                        </li>
                                        <li class="children">
                                            <i class="tree"></i>{{tag.value.tag.code}}  ({{tag.value.tag.name}})
                                            <input type="hidden" name="tag[{{tag.value.id}},{{ tag.value.tag.id }}]" value="{{tag.value.parent_id}},{{tag.value.ordernum}}">
                                            <ul id="sortable" class=" sortable">
                                    {%- endif -%}
                                    {%- if k < 0 -%}
                                          <li class="children">
                                                <i class="tree"></i>{{tag.value.tag.code}}  ({{tag.value.tag.name}})
                                                <input type="hidden" name="tag[{{tag.value.id}},{{ tag.value.tag.id }}]" value="{{tag.value.parent_id}},{{tag.value.ordernum}}">
                                                <ul  id="sortable" class=" sortable">
                                    {%- endif -%}
                                    {%- if k > 0 -%}
                                        {%- for i in range(k + 1) -%}
                                            </ul>
                                             </li>
                                        {%- endfor -%}
                                            <li class="children">
                                                <i class="tree"></i>{{tag.value.tag.code}}  ({{tag.value.tag.name}})
                                                <input type="hidden" name="tag[{{tag.value.id}},{{ tag.value.tag.id }}]" value="{{tag.value.parent_id}},{{tag.value.ordernum}}">
                                                <ul id="sortable" class=" sortable">
                                    {%- endif -%}
                                {%- endif -%}
                           {%- endfor -%}
                            </ul>
                            </li>
                          </ul>
                        </div>
                        <div class="span5 well col" id="unused">
                          <legend>Не используются</legend>
                          <ul id="root" class="sortable col">
                          {%- for tag in unused_tags -%}
                              <li>
                                {{ tag.tag.name }} ({{ tag.tag.code }})
                                <input type="hidden" id="hid_{{tag.id}}" name="unusedtag[None,{{ tag.tag_id }}]" value="None,1">
                                <ul id="sortable" class="sortable">
                                </ul>
                              </li>
                          {%- endfor -%}
                          </ul>
                        </div>
                    </div>
                    <div class="row-fluid col-wrap">
                        <!-- add a second row of wells or rounded corner divs immeadiately underneath-->
                        <div class="span7 col-base well"></div>
                        <div class="span5 col-base well"></div>
                    </div>
                    <hr>
                    <div class="row-fluid">
                        <div class="span6">
                            {% if current_id %}
                                <a class="btn btn-danger btn-large" href="{{ url_for('.delete_template', template_type='xml_patient', action='delete_template', id=current_id)}}">Удалить шаблон</a>
                            {% endif %}
                        </div>
                        <div class="span6 pull-right">
                            {% if current_id %}
                            <button name="btn" value="Save_as_new" type="submit" class="btn btn-large">Сохранить как новый</button>
                            {% endif %}
                            <button name="btn" value="Save" type="submit" class="pull-right btn btn-success btn-large">Сохранить</button>
                        </div>
                    </div>
                </form>
          </div>
        </div>

{% endblock %}
{% block modules_js %}
  <script src="{{ url_for('static', filename='jquery-ui/js/jquery-1.9.1.js') }}"></script>
  <script src="{{ url_for('static', filename='jquery-ui/js/jquery-ui-1.10.2.custom.min.js') }}"></script>
  <script>

  $(function() {

    $("input[name=is_active]:radio").change(
            function(){
                var item = $(this);
                if ($(this).is(':checked')){
                    console.log(item.attr('value'))
                    $.ajax({
                            url : '.',
                            type : 'POST',
                            data: {activate:item.attr('value')}
                    });
                }
                else{
                    $.ajax({
                            url : '.',
                            type : 'POST',
                            data: {deactivate:item.attr('value')}
                    });
                }

            }
    );

    $( ".sortable" ).sortable({
        connectWith: 'ul.sortable',
        opacity: 0.6,
        cursor: "move",
        placeholder: "ui-state-highlight",

        stop: function (event, ui) {
            var item = ui.item;
            var isused = item.closest('div').attr('id');
            //var item_parent_input = ui.item.children('input');
            var descendants = item.find('input');
            var siblings = ui.item.parent().children();
            var parent_input = item.parent().parent().children('input');
            var number_of_children = parent_input.length;

            var parent_id = 'None';
            if(number_of_children>0){
                var name_parent = parent_input.attr('name');
                var re = /tag\[(\d+),\d+\]/i;
                var re1 = /tag\[None,(\d+)\]/i
                parent_id = name_parent.match(re);
                if (parent_id){
                    parent_id = parent_id[1];
                }
                else{
                    parent_id = name_parent.match(re1);
                    if (parent_id){
                        parent_id = 't'+parent_id[1];
                    }
                    else{
                       parent_id = 'None';
                    }
                }
            }

            if(isused === 'used'){
                descendants.each(function(index, el){
                    var descendant = $(this);
                    var new_name = descendant.attr('name').replace(/unused/,"");
                    new_name = new_name.replace(/removed/,"");
                    descendant.attr('name', new_name);
                });
                console.log('unused')
            }
            else{
                descendants.each(function(index, el){
                    var descendant = $(this);
                    var old_name = descendant.attr('name');
                    descendant.attr('name', 'removed'+old_name);
                });
                console.log('now unused')
            }

            if (isused === 'used'){
                siblings.each(function(index, el){
                    item = $(this).children('input');
                    var ordernum_value = index+1;
                    item.val(parent_id+','+ordernum_value);
                });

            }

        }
    });
    $( "ul, li" ).disableSelection();
    //$("#sortable, #sortable2").css('minHeight',"0px");
  });
  </script>
{% endblock %}