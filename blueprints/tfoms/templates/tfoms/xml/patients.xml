<?xml version="1.0" encoding="{{ encoding }}"?>
{%- for item in tags_tree recursive -%}
<{{ item.tag.code }}>
    {%- if item.children -%}
        {%- if item.tag.code == 'PERS' -%}
            {%- for person in data -%}
                {%- if not loop.first -%}
                </{{ item.tag.code }}><{{ item.tag.code }}>
                {%- endif -%}
                {%- for node in item.children -%}
                    <{{ node.tag.code }}>
                        {%- if node.tag.code == 'ID_PAC' -%}
                            {{ person|attr('patientId') }}
                        {%- elif node.tag.code == 'SNILS' and person|attr(node.tag.code) -%}
                            {{ person|attr(node.tag.code)|wordwrap(3, wrapstring="-") }}
                        {%- elif person|attr(node.tag.code) -%}
                            {%- if node.tag.code in ['DR'] -%}
                                {{ person|attr(node.tag.code)|datetimeformat('%Y-%m-%d') }}
                            {%- else -%}
                                {{ person|attr(node.tag.code) }}
                            {%- endif -%}
                        {%- endif -%}
                    </{{ node.tag.code }}>
                {%- endfor -%}
            {%- endfor -%}
        {%- else -%}
            {{ loop(item.children) }}
        {%- endif -%}
    {%- else -%}
        {%- if item.parent.tag.code == 'ZGLV' -%}
        {{ head[item.tag.code] }}
        {%- endif -%}
    {%- endif -%}
</{{ item.tag.code }}>
{%- endfor %}