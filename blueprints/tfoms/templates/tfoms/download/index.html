{% extends 'base.html' %}

{% block title %}> {{ module_name }} > Формирование реестров{% endblock %}

{% block modules_css %}
<link href="{{ url_for('.static', filename='css/style.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='jquery-ui/css/cupertino/jquery-ui-1.10.2.custom.min.css') }}" rel="stylesheet">
{#<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/flick/jquery-ui.css" />#}
{% endblock %}

{% block content %}

    {% include 'tfoms/_nav_menu.html' %}
        <legend>Формирование реестров, предназначенных для выгрузки в ТФОМС</legend>
        <ul class="nav nav-tabs">
            <li{% if request.path == url_for('.download', template_type='xml') or request.path == url_for('.download') %} class="active"{% endif %}><a href="{{ url_for('.download', template_type='xml') }}">Выгрузка сведений в формате XML</a></li>
            <li{% if request.path == url_for('.download', template_type='dbf') %} class="active"{% endif %}><a href="{{ url_for('.download', template_type='dbf') }}">Выгрузка  сведений в формате DBF</a></li>
        </ul>
        <form class="form-horizontal" id="download_form">
            <legend><small>Укажите параметры выгрузки</small></legend>
            <div class="row">
                <div class="span6">
                <div class="alert alert-error hidden">
                  <strong>Внимание!</strong> <span id="error_text"></span>
                </div>
                <div class="control-group">
                    <label class="control-label">Отчетный период:</label>
                    <div class="controls">
                        <div class="input-prepend">
                            <span class="add-on">с</span>
                            <input type="text" id="from" name="start" required class="input-small" />
                        </div>
                        <div class="input-prepend">
                            <span class="add-on">по</span>
                            <input type="text" id="to" name="end" required class="input-small" />
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Формировать:</label>
                    <div class="controls well well-small">
                        {% for template in templates %}
                            <label class="checkbox"><input type="checkbox" class="templates" checked="checked" name="templates[]" value="{{ template.id }}">{{ template.name }}</label>
                        {% endfor %}
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls">
                        <button type="submit" class="btn btn-primary">Сформировать выгрузку</button>
                    </div>
                </div>
                </div>
            </div>
        </form>
<div id="download_result">
<legend>Скачивание файлов</legend>
<div id="result"></div>
</div>
<div class="loader"></div>
{% endblock %}
{% block modules_js %}
<script src="{{ url_for('static', filename='jquery-ui/js/jquery-ui-1.10.2.custom.min.js') }}"></script>
<script src="{{ url_for('static', filename='jquery-ui/js/i18n/jquery.ui.datepicker-ru.js') }}"></script>
<script type="text/javascript">
function show_error(text){
    $('#error_text').text(text);
    $(".alert").removeClass('hidden');
}
$(document).ready(function(){
    $('#download_result').hide();
    $(document).on({
        ajaxStart: function() {
            $('body').addClass("loading");
        },
        ajaxStop: function() {
            $('body').removeClass("loading");
        }
    });
    $('#download_form').submit(function(){
        var $this = $(this);
        var templates = [];
        $this.find('input:checkbox').each(function(){
            if ($(this).is(':checked')){
                templates.push($(this).val());
            }
        });
        if (!templates.length){
            show_error('Не выбран ни один шаблон для выгрузки');
            return false;
        }
        $this.hide();
        $('#download_result').show();
        $('#result').html('Подождите, идёт генерация файлов...');
        $.post("{{ url_for('.ajax_download') }}",
                { templates: templates, start: $('#from').val(), end: $('#to').val() },
                function(res) {
                    if (res.error){
                        show_error(res.error);
                        $('#download_result').hide();
                        $this.show();
                    }else{
                        $('#result').html(res);
                    }
                }
        );
        return false;
    });
});
$(function() {
    $( "#from" ).datepicker({
      changeMonth: true,
      onClose: function( selectedDate ) {
        $( "#to" ).datepicker( "option", "minDate", selectedDate );
      }
    });
    $( "#to" ).datepicker({
      defaultDate: "+1w",
      changeMonth: true,
      onClose: function( selectedDate ) {
        $( "#from" ).datepicker( "option", "maxDate", selectedDate );
      }
    });
});
</script>
{% endblock %}